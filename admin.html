<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foodie Admin - Elite Ultra Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; color: #1e293b; }
        .nav-text { font-size: 10px; font-weight: 800; letter-spacing: 1px; color: #94a3b8; cursor: pointer; padding: 10px; }
        .nav-text.active { color: #F97316; border-bottom: 3px solid #F97316; }
        .tab-btn { flex: 1; padding: 12px; font-size: 11px; font-weight: 800; border-radius: 12px; transition: 0.3s; color: #64748b; }
        .tab-btn.active { background: #1e293b; color: white; }
        .grid-layout { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; border-bottom: 1px solid #f1f5f9; padding: 10px 0; font-size: 11px; font-weight: 700; }
        #voucher-preview { position: absolute; left: -9999px; top: 0; background: white; width: 300px; padding: 20px; }
    </style>
</head>
<body class="pb-32">

    <header class="bg-white sticky top-0 z-[100] p-5 px-8 flex justify-between items-center border-b border-slate-100 shadow-sm">
        <h1 class="text-xl font-black italic tracking-tighter">ADMIN.SYSTEM</h1>
        <div class="flex items-center gap-6">
            <div class="relative cursor-pointer" onclick="showNotiBox()">
                <span class="text-2xl">ðŸ””</span>
                <span id="noti-dot" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[8px] flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
            </div>
            <button onclick="fetchData()" class="bg-slate-50 p-2 rounded-xl text-xs font-black">SYNC</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        
        <section id="tab-dashboard" class="grid grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase">Revenue</p>
                <h2 id="stat-revenue" class="text-2xl font-black text-slate-800">0 Ks</h2>
            </div>
            <div class="bg-orange-500 text-white p-6 rounded-[2.5rem] shadow-lg shadow-orange-100">
                <p class="text-[10px] font-black opacity-80 uppercase">Total Orders</p>
                <h2 id="stat-orders" class="text-2xl font-black">0</h2>
            </div>
            <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase">Customers</p>
                <h2 id="stat-customers" class="text-2xl font-black">0</h2>
            </div>
            <div class="bg-red-50 p-6 rounded-[2.5rem] border border-red-100 shadow-sm">
                <p class="text-[10px] font-black text-red-400 uppercase">Stock Alert</p>
                <h2 id="stat-stock" class="text-2xl font-black text-red-600">0</h2>
            </div>
        </section>

        <section id="tab-orders" class="hidden space-y-6">
            <div class="flex bg-slate-200/50 p-1.5 rounded-2xl gap-2">
                <button onclick="filterOrdersBy('not_confirm')" class="status-tab tab-btn active" id="btn-not_confirm">NEW</button>
                <button onclick="filterOrdersBy('pending')" class="status-tab tab-btn" id="btn-pending">PENDING</button>
                <button onclick="filterOrdersBy('ready')" class="status-tab tab-btn" id="btn-ready">READY</button>
            </div>
            <input type="text" id="order-search" oninput="renderOrders()" placeholder="Search Phone, Name or Order ID..." class="w-full p-5 rounded-[1.5rem] bg-white border-none ring-1 ring-slate-100 outline-none focus:ring-2 focus:ring-orange-500 font-bold shadow-sm">
            <div id="order-list" class="space-y-4"></div>
        </section>

        <section id="tab-menu" class="hidden space-y-6">
            <button onclick="openMenuModal()" class="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black text-sm shadow-xl">+ NEW ITEM</button>
            <div id="admin-menu-list" class="grid grid-cols-1 gap-3"></div>
        </section>

        <section id="tab-customers" class="hidden space-y-6">
            <input type="text" id="cust-search" oninput="renderCustomers()" placeholder="Search Customers..." class="w-full p-5 rounded-[1.5rem] bg-white border-none ring-1 ring-slate-100 font-bold shadow-sm">
            <div id="admin-customer-list" class="space-y-3"></div>
        </section>
    </main>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-4">
            <h3 id="modal-title" class="text-xl font-black">Item Detail</h3>
            <input type="text" id="m-name" placeholder="Item Name" class="w-full p-4 rounded-xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold">
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="m-price" placeholder="Price" class="p-4 rounded-xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold">
                <input type="number" id="m-stock" placeholder="Stock" class="p-4 rounded-xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold">
            </div>
            <div class="space-y-2">
                <input type="text" id="m-image-url" placeholder="Image URL" class="w-full p-4 rounded-xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold text-xs">
                <label class="block w-full bg-blue-50 text-blue-600 p-4 rounded-xl text-center text-[10px] font-black cursor-pointer uppercase border border-blue-100">
                    Upload from phone
                    <input type="file" id="m-file" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                </label>
                <img id="img-preview" src="" class="w-20 h-20 object-cover rounded-xl mt-2 hidden border">
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="closeMenuModal()" class="flex-1 py-4 font-black text-slate-400">Cancel</button>
                <button onclick="saveMenu()" id="save-btn" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-black">Save Now</button>
            </div>
        </div>
    </div>

    <div id="voucher-preview"></div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white border-t border-slate-100 flex items-center justify-around px-4 z-[90]">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-text active uppercase">Dashboard</button>
        <button onclick="switchTab('orders')" id="nav-orders" class="nav-text uppercase">Orders</button>
        <button onclick="switchTab('menu')" id="nav-menu" class="nav-text uppercase">Menu</button>
        <button onclick="switchTab('customers')" id="nav-customers" class="nav-text uppercase">Customers</button>
    </nav>

    <script>
        const SUPABASE_URL = 'https://rvqkolgbykgsqjupmedf.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2cWtvbGdieWtnc3FqdXBtZWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDcyNTAsImV4cCI6MjA4MzI4MzI1MH0.fqxJ9aHAHmySpmTaJ-tpfeEsE7IFBr-JkYIdAQCLjQs'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let orders = [], menus = [], customers = [], currentFilter = 'not_confirm', uploadedBase64 = "", editingId = null;
        let newOrdersCount = 0;

        async function fetchData() {
            const { data: o } = await _supabase.from('orders').select('*, order_items(*, menus(*))').order('created_at', { ascending: false });
            const { data: m } = await _supabase.from('menus').select('*').order('name');
            orders = o || [];
            menus = m || [];
            
            // Generate Customers Data
            const map = new Map();
            customers = [];
            orders.forEach(ord => {
                if(!map.has(ord.customer_phone)) {
                    map.set(ord.customer_phone, true);
                    customers.push({ name: ord.customer_name, phone: ord.customer_phone });
                }
            });

            newOrdersCount = orders.filter(x => x.status === 'not_confirm').length;
            updateUI();
        }

        function updateUI() {
            document.getElementById('stat-revenue').innerText = orders.reduce((s, o) => s + o.total_amount, 0).toLocaleString() + " Ks";
            document.getElementById('stat-orders').innerText = orders.length;
            document.getElementById('stat-customers').innerText = customers.length;
            document.getElementById('stat-stock').innerText = menus.filter(m => m.stock < 5).length;
            
            const dot = document.getElementById('noti-dot');
            if(newOrdersCount > 0) {
                dot.innerText = newOrdersCount;
                dot.classList.remove('hidden');
            } else { dot.classList.add('hidden'); }

            renderOrders();
            renderMenus();
            renderCustomers();
        }

        function renderOrders() {
            const search = document.getElementById('order-search').value.toLowerCase();
            const filtered = orders.filter(o => o.status === currentFilter && (o.customer_phone.includes(search) || o.customer_name.toLowerCase().includes(search) || o.id.toString().includes(search)));
            
            document.getElementById('order-list').innerHTML = filtered.map(o => `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-50">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-[9px] font-black text-orange-500 mb-1 uppercase tracking-tighter">Order ID: #${o.id.toString().slice(-6)}</p>
                            <h4 class="font-black text-lg text-slate-800 underline cursor-pointer" onclick="showCustHistory('${o.customer_phone}')">${o.customer_name}</h4>
                            <p class="text-xs font-bold text-slate-400">Phone: ${o.customer_phone}</p>
                        </div>
                        <button onclick="printVoucher('${o.id}')" class="bg-slate-50 p-3 rounded-2xl text-[10px] font-black">VOUCHER</button>
                    </div>
                    <div class="bg-slate-50/50 p-4 rounded-2xl border border-slate-100">
                        <div class="grid-layout text-[9px] text-slate-400 uppercase font-black border-b border-slate-200 pb-2 mb-2">
                            <span>Name</span><span>Price</span><span>Qty</span><span>Total</span>
                        </div>
                        ${o.order_items.map(i => `
                            <div class="grid-layout">
                                <span class="truncate pr-2">${i.menus?.name || 'Item'}</span>
                                <span>${i.price_at_time.toLocaleString()}</span>
                                <span class="text-center">${i.quantity}</span>
                                <span class="text-right text-orange-600 font-black">${(i.price_at_time * i.quantity).toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between items-center mt-5">
                        <p class="font-black text-xl">${o.total_amount.toLocaleString()} Ks</p>
                        <div class="flex gap-2">
                            ${currentFilter !== 'pending' ? `<button onclick="updateStatus('${o.id}', 'pending')" class="bg-slate-100 px-4 py-2 rounded-xl text-[9px] font-black uppercase">PENDING</button>` : ''}
                            ${currentFilter !== 'ready' ? `<button onclick="updateStatus('${o.id}', 'ready')" class="bg-green-500 text-white px-4 py-2 rounded-xl text-[9px] font-black shadow-lg shadow-green-100 uppercase">READY</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterOrdersBy(s) {
            currentFilter = s;
            document.querySelectorAll('.status-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + s).classList.add('active');
            renderOrders();
        }

        function showNotiBox() {
            Swal.fire({
                title: 'Notifications',
                html: `<div class="text-left p-2">
                        <p class="font-bold text-orange-600 text-sm mb-2">New Orders Alert!</p>
                        <p class="text-slate-500 text-xs">You have <b>${newOrdersCount}</b> new orders waiting to be confirmed.</p>
                        <hr class="my-4">
                        <p class="text-[10px] text-slate-400">Click on 'Orders' tab and select 'NEW' to process them.</p>
                       </div>`,
                confirmButtonText: 'View Now',
                confirmButtonColor: '#F97316',
                customClass: { popup: 'rounded-[2rem]' }
            }).then((res) => { if(res.isConfirmed) switchTab('orders'); });
        }

        function showCustHistory(phone) {
            const h = orders.filter(o => o.customer_phone === phone);
            const user = customers.find(c => c.phone === phone);
            const html = h.map(o => `
                <div class="bg-slate-50 p-4 rounded-2xl mb-3 text-left border border-slate-100">
                    <div class="flex justify-between font-black text-[10px] border-b border-slate-200 pb-2 mb-2 uppercase">
                        <span>${new Date(o.created_at).toLocaleDateString()}</span>
                        <span class="text-orange-600">${o.total_amount.toLocaleString()} Ks</span>
                    </div>
                    <div class="space-y-1">
                        ${o.order_items.map(i => `
                            <div class="flex justify-between text-[9px] font-bold">
                                <span>${i.menus?.name} (${i.quantity} x ${i.price_at_time})</span>
                                <span>${(i.quantity * i.price_at_time).toLocaleString()} Ks</span>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-[8px] mt-2 font-black text-slate-400 uppercase">Status: ${o.status}</p>
                </div>
            `).join('');
            
            Swal.fire({
                title: user.name,
                html: `<p class="text-xs font-bold text-slate-400 mb-4">${user.phone}</p><div class="max-h-96 overflow-y-auto">${html || 'No orders yet.'}</div>`,
                showConfirmButton: false,
                customClass: { popup: 'rounded-[2.5rem]' }
            });
        }

        // IMAGE HANDLER
        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedBase64 = e.target.result;
                    const preview = document.getElementById('img-preview');
                    preview.src = e.target.result; preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveMenu() {
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "Saving...";
            const img = uploadedBase64 || document.getElementById('m-image-url').value || "https://placehold.co/400x400?text=Food";
            
            const obj = {
                name: document.getElementById('m-name').value,
                price: parseInt(document.getElementById('m-price').value),
                stock: parseInt(document.getElementById('m-stock').value),
                image_url: img
            };

            if(editingId) await _supabase.from('menus').update(obj).eq('id', editingId);
            else await _supabase.from('menus').insert([obj]);

            closeMenuModal(); fetchData(); btn.disabled = false; btn.innerText = "Save Now";
        }

        function renderMenus() {
            document.getElementById('admin-menu-list').innerHTML = menus.map(m => `
                <div class="bg-white p-4 rounded-3xl flex items-center justify-between border border-slate-100 shadow-sm">
                    <div class="flex items-center gap-4">
                        <img src="${m.image_url}" class="w-14 h-14 object-cover rounded-2xl border border-slate-50">
                        <div>
                            <p class="font-black text-sm text-slate-800">${m.name}</p>
                            <p class="text-[10px] font-bold text-orange-500 uppercase">${m.price.toLocaleString()} Ks | Stock: ${m.stock}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openMenuModal('${m.id}')" class="p-3 bg-slate-50 rounded-xl text-blue-500 text-[10px] font-black uppercase">Edit</button>
                        <button onclick="deleteMenu('${m.id}')" class="p-3 bg-red-50 rounded-xl text-red-400 text-[10px] font-black uppercase">Del</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomers() {
            const search = document.getElementById('cust-search').value.toLowerCase();
            const filtered = customers.filter(c => c.name.toLowerCase().includes(search) || c.phone.includes(search));
            document.getElementById('admin-customer-list').innerHTML = filtered.map(c => `
                <div onclick="showCustHistory('${c.phone}')" class="bg-white p-5 rounded-[2rem] flex justify-between items-center border border-slate-100 cursor-pointer shadow-sm">
                    <div><p class="font-black text-sm">${c.name}</p><p class="text-xs text-slate-400 font-bold">${c.phone}</p></div>
                    <span class="text-orange-500 font-black text-[10px] uppercase">Profile â†’</span>
                </div>
            `).join('');
        }

        function printVoucher(id) {
            const o = orders.find(x => x.id === id);
            const container = document.getElementById('voucher-preview');
            container.innerHTML = `
                <div style="font-family: Arial, sans-serif; color: #000; padding: 20px; width: 280px; background: #fff;">
                    <h2 style="text-align: center; margin-bottom: 2px;">FOODIE.</h2>
                    <p style="text-align: center; font-size: 10px; margin-bottom: 15px;">Official Receipt</p>
                    <div style="font-size: 11px; margin-bottom: 10px;">
                        <p>Order: #${o.id.toString().slice(-6)}</p>
                        <p>Cust: ${o.customer_name}</p>
                        <p>Phone: ${o.customer_phone}</p>
                        <p>Date: ${new Date(o.created_at).toLocaleString()}</p>
                    </div>
                    <table style="width: 100%; border-top: 1px solid #000; border-bottom: 1px solid #000; font-size: 11px; border-collapse: collapse;">
                        <tr style="border-bottom: 1px dashed #ccc;"><th style="text-align: left; padding: 5px 0;">Item</th><th style="text-align: center;">Qty</th><th style="text-align: right;">Total</th></tr>
                        ${o.order_items.map(i => `<tr><td style="padding: 5px 0;">${i.menus?.name}</td><td style="text-align: center;">${i.quantity}</td><td style="text-align: right;">${(i.price_at_time * i.quantity).toLocaleString()}</td></tr>`).join('')}
                    </table>
                    <div style="text-align: right; margin-top: 15px; font-size: 14px;"><b>TOTAL: ${o.total_amount.toLocaleString()} Ks</b></div>
                    <p style="text-align: center; font-size: 10px; margin-top: 25px;">-- THANK YOU --</p>
                </div>
            `;
            html2canvas(container).then(canvas => {
                const link = document.createElement('a');
                link.download = `Voucher_${o.customer_name}.png`; link.href = canvas.toDataURL(); link.click();
            });
        }

        // TAB SYSTEM
        function switchTab(t) {
            ['dashboard', 'orders', 'menu', 'customers'].forEach(id => {
                document.getElementById('tab-' + id).classList.add('hidden');
                document.getElementById('nav-' + id).classList.remove('active');
            });
            document.getElementById('tab-' + t).classList.remove('hidden');
            document.getElementById('nav-' + t).classList.add('active');
        }

        // REAL-TIME
        _supabase.channel('orders').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, () => {
            new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play();
            fetchData();
        }).subscribe();

        function openMenuModal(id = null) {
            editingId = id; uploadedBase64 = ""; document.getElementById('img-preview').classList.add('hidden');
            if(id) {
                const m = menus.find(x => x.id === id);
                document.getElementById('m-name').value = m.name; document.getElementById('m-price').value = m.price;
                document.getElementById('m-stock').value = m.stock; document.getElementById('m-image-url').value = m.image_url;
            } else { ['m-name', 'm-price', 'm-stock', 'm-image-url'].forEach(i => document.getElementById(i).value = ''); }
            document.getElementById('menu-modal').classList.remove('hidden');
        }

        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        async function deleteMenu(id) { if(confirm('Delete?')) { await _supabase.from('menus').delete().eq('id', id); fetchData(); } }
        async function updateStatus(id, s) { await _supabase.from('orders').update({ status: s }).eq('id', id); fetchData(); }
        
        fetchData();
    </script>
</body>
</html>
