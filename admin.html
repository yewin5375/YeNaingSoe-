<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>မြင်သာကြက်ကင် - Admin Panel</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');
    body { font-family: 'Pyidaungsu', sans-serif; -webkit-tap-highlight-color: transparent; }
    .page { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
    .page.visible { display: block; opacity: 1; transform: translateY(0); }
    .tab-btn.active { background: #f97316; color: white; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); }
    #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
    #sidebar.closed { transform: translateX(-100%); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .order-card { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/40 z-[900] hidden backdrop-blur-sm"></div>

  <header class="bg-white/80 backdrop-blur-md border-b p-4 sticky top-0 z-[500] flex justify-between items-center shadow-sm">
    <div class="flex items-center gap-3">
      <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>
      <h1 class="font-black text-lg text-orange-600 tracking-tight" id="page-title">DASHBOARD</h1>
    </div>
    
    <div class="relative">
      <button onclick="toggleNotif()" class="p-2 bg-slate-100 rounded-xl relative">
        <i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>
        <span id="notif-dot" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white hidden animate-ping"></span>
      </button>
      <div id="notif-dropdown" class="absolute right-0 mt-3 w-80 bg-white shadow-2xl rounded-2xl border hidden p-4 z-[600]">
        <div class="flex justify-between items-center border-b pb-2 mb-2"><span class="font-bold">Notifications</span></div>
        <div id="notif-list" class="space-y-2 max-h-80 overflow-y-auto no-scrollbar text-xs">
          <p class="text-center text-slate-400 py-4">သတိပေးချက်မရှိသေးပါ</p>
        </div>
      </div>
    </div>
  </header>

  <div class="flex">
    <aside id="sidebar" class="fixed top-0 left-0 w-72 h-full bg-white border-r closed shadow-2xl overflow-y-auto">
      <div class="p-6 border-b flex justify-between items-center bg-orange-600 text-white">
        <div><h2 class="font-black text-xl">Admin Control</h2></div>
        <button onclick="toggleSidebar()" class="p-2 hover:bg-white/20 rounded-lg"><i data-lucide="chevron-left"></i></button>
      </div>
      <nav class="p-4 space-y-1">
        <button onclick="switchPage('dashboard')" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 hover:bg-orange-50">
          <i data-lucide="layout-dashboard"></i> Dashboard
        </button>
        <button onclick="switchPage('orders')" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 hover:bg-orange-50">
          <i data-lucide="shopping-cart"></i> Orders
        </button>
        <button onclick="switchPage('menu')" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 hover:bg-orange-50">
          <i data-lucide="utensils"></i> Menu Items
        </button>
        <button onclick="switchPage('add-menu')" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-orange-600 bg-orange-50/50">
          <i data-lucide="plus-circle"></i> Add New Menu
        </button>
        <button onclick="switchPage('customers')" class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold text-slate-600 hover:bg-orange-50">
          <i data-lucide="users"></i> Customers
        </button>
      </nav>
    </aside>

    <main class="flex-1 p-4 lg:p-8 max-w-5xl mx-auto w-full">
      <section id="page-dashboard" class="page visible space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white p-6 rounded-[2rem] border shadow-sm flex flex-col items-center">
            <p class="text-xs font-bold text-slate-400">TOTAL ORDERS</p>
            <h2 id="total-orders" class="text-3xl font-black">0</h2>
          </div>
          <div class="bg-white p-6 rounded-[2rem] border shadow-sm flex flex-col items-center">
            <p class="text-xs font-bold text-slate-400">REVENUE</p>
            <h2 id="total-revenue" class="text-2xl font-black text-orange-600">0 Ks</h2>
          </div>
        </div>
        <div class="bg-white p-6 rounded-[2rem] border shadow-sm">
          <h3 class="font-black mb-4">လတ်တလော မှာယူမှုများ</h3>
          <ul id="dash-recent-orders" class="space-y-4"></ul>
        </div>
      </section>

      <section id="page-add-menu" class="page">
        <div class="max-w-xl mx-auto bg-white p-8 rounded-[2.5rem] border shadow-xl">
          <form id="menu-form" class="space-y-4">
            <input type="hidden" id="menu-id">
            <input type="text" id="menu-name" placeholder="Item Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none" required>
            <div class="grid grid-cols-2 gap-4">
              <input type="number" id="menu-price" placeholder="Price (Ks)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none" required>
              <input type="number" id="menu-stock" placeholder="Stock" class="w-full p-4 bg-slate-50 rounded-2xl outline-none" required>
            </div>
            <input type="text" id="menu-image-url" placeholder="Image URL" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
            <button type="submit" id="save-btn" class="w-full bg-orange-600 text-white font-black py-5 rounded-[2rem]">SAVE DATA</button>
          </form>
        </div>
      </section>

      <section id="page-menu" class="page space-y-4">
        <div id="menu-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>

      <section id="page-orders" class="page">
        <div class="flex gap-2 mb-6 p-1 bg-slate-200/50 rounded-2xl">
          <button onclick="setOrderStatusTab('new')" class="tab-btn active flex-1 py-3 rounded-xl text-xs font-black" data-status="new">NEW</button>
          <button onclick="setOrderStatusTab('pending')" class="tab-btn flex-1 py-3 rounded-xl text-xs font-black" data-status="pending">PENDING</button>
          <button onclick="setOrderStatusTab('finished')" class="tab-btn flex-1 py-3 rounded-xl text-xs font-black" data-status="finished">DONE</button>
        </div>
        <div id="order-cards" class="space-y-4"></div>
      </section>

      <section id="page-customers" class="page">
        <div class="bg-white rounded-[2.5rem] border shadow-sm overflow-hidden">
          <ul id="customer-list-items" class="divide-y divide-slate-100"></ul>
        </div>
      </section>
    </main>
  </div>

  <audio id="order-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" preload="auto"></audio>
  <script>
      const SUPABASE_URL = 'https://rvqkolgbykgsqjupmedf.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2cWtvbGdieWtnc3FqdXBtZWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDcyNTAsImV4cCI6MjA4MzI4MzI1MH0.fqxJ9aHAHmySpmTaJ-tpfeEsE7IFBr-JkYIdAQCLjQs'; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentStatusTab = 'new';

async function init() {
    renderDashboard();
    fetchMenu();
    fetchOrders();
    fetchCustomers();
    listenToRealtime();
    lucide.createIcons();
}

// Sidebar & Page Switch
window.toggleSidebar = () => {
    document.getElementById('sidebar').classList.toggle('closed');
    document.getElementById('sidebar-overlay').classList.toggle('hidden');
};

window.switchPage = (pageId) => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('visible'));
    document.getElementById('page-' + pageId).classList.add('visible');
    document.getElementById('page-title').innerText = pageId.toUpperCase();
    if(window.innerWidth < 1024) toggleSidebar();
};

// Dashboard Stats
async function renderDashboard() {
    const { data: orders } = await _supabase.from('orders').select('*');
    if (!orders) return;
    document.getElementById('total-orders').innerText = orders.length;
    const revenue = orders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
    document.getElementById('total-revenue').innerText = revenue.toLocaleString() + " Ks";
    
    const recent = orders.slice(-5).reverse();
    document.getElementById('dash-recent-orders').innerHTML = recent.map(o => `
        <li class="flex justify-between p-3 border-b last:border-0">
            <span class="text-sm font-bold">${o.customer_name}</span>
            <span class="text-orange-600 font-black">${o.total_amount.toLocaleString()} K</span>
        </li>
    `).join('');
}

// Menu Management
async function fetchMenu() {
    const { data } = await _supabase.from('menus').select('*').order('name');
    document.getElementById('menu-list').innerHTML = data.map(item => `
        <div class="bg-white p-4 rounded-[2rem] border flex items-center gap-4">
            <img src="${item.image_url}" class="w-14 h-14 object-cover rounded-xl">
            <div class="flex-1">
                <h4 class="font-bold text-sm">${item.name}</h4>
                <p class="text-orange-600 font-black text-xs">${item.price.toLocaleString()} Ks</p>
            </div>
            <button onclick="deleteMenu('${item.id}')" class="p-2 text-red-500"><i data-lucide="trash-2"></i></button>
        </div>
    `).join('');
    lucide.createIcons();
}

// Order Management
async function fetchOrders() {
    const { data } = await _supabase.from('orders').select('*, order_items(*, menus(*))').eq('status', currentStatusTab).order('created_at', { ascending: false });
    document.getElementById('order-cards').innerHTML = data.map(o => `
        <div class="order-card bg-white p-6 rounded-[2.5rem] border shadow-sm">
            <div class="flex justify-between mb-4">
                <h4 class="font-black">${o.customer_name}</h4>
                <span class="text-orange-600 font-black">${o.total_amount.toLocaleString()} K</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-2xl text-xs mb-4">
                ${o.order_items.map(i => `<div class="flex justify-between"><span>${i.quantity}x ${i.menus?.name}</span></div>`).join('')}
            </div>
            <button onclick="updateStatus('${o.id}', '${o.status === 'new' ? 'pending' : 'finished'}')" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">
                ${o.status === 'new' ? 'CONFIRM ORDER' : 'MARK AS DONE'}
            </button>
        </div>
    `).join('');
    lucide.createIcons();
}

window.setOrderStatusTab = (status) => {
    currentStatusTab = status;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.status === status));
    fetchOrders();
};

async function updateStatus(id, status) {
    await _supabase.from('orders').update({ status }).eq('id', id);
    fetchOrders();
    renderDashboard();
}

// Real-time Order Alert
function listenToRealtime() {
    _supabase.channel('orders-channel').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
        document.getElementById('order-sound').play();
        fetchOrders();
        renderDashboard();
    }).subscribe();
}

// Customer List
async function fetchCustomers() {
    const { data } = await _supabase.from('orders').select('customer_name, customer_phone, total_amount');
    const custs = {};
    data.forEach(d => {
        if(!custs[d.customer_phone]) custs[d.customer_phone] = { name: d.customer_name, phone: d.customer_phone, spent: 0 };
        custs[d.customer_phone].spent += d.total_amount;
    });
    document.getElementById('customer-list-items').innerHTML = Object.values(custs).map(c => `
        <li class="p-4 flex justify-between">
            <div><p class="font-bold text-sm">${c.name}</p><p class="text-xs text-slate-400">${c.phone}</p></div>
            <span class="font-black text-xs">${c.spent.toLocaleString()} K</span>
        </li>
    `).join('');
}

// Add/Update Menu Form
document.getElementById('menu-form').onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
        name: document.getElementById('menu-name').value,
        price: parseInt(document.getElementById('menu-price').value),
        stock: parseInt(document.getElementById('menu-stock').value),
        image_url: document.getElementById('menu-image-url').value
    };
    await _supabase.from('menus').insert([payload]);
    alert('Menu Added!');
    switchPage('menu');
    fetchMenu();
};

init();
      
  </script>
</body>
</html>
