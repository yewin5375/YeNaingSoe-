<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ultimate BBQ Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfcfb; }
        .google-btn { background: white; border: 1px solid #dadce0; color: #3c4043; transition: background-color .218s, border-color .218s, box-shadow .218s; }
        .nav-active { color: #f97316; font-weight: 800; border-bottom: 3px solid #f97316; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        #order-bell { animation: ring 2s infinite; }
        @keyframes ring { 0% { transform: rotate(0); } 10% { transform: rotate(15deg); } 20% { transform: rotate(-15deg); } 30% { transform: rotate(0); } }
    </style>
</head>
<body class="pb-24">

    <div id="login-screen" class="fixed inset-0 z-[2000] bg-slate-900 flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-10 text-center shadow-2xl">
            <h2 class="text-2xl font-black mb-6">Staff Only</h2>
            <button onclick="loginWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 py-3 rounded-lg font-bold">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-5 h-5">
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="admin-content" class="hidden">
        <header class="bg-white border-b sticky top-0 z-[100] px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black italic text-orange-600">BBQ<span class="text-slate-900">.PRO</span></h1>
            <div class="flex items-center gap-4">
                <img id="admin-profile" src="" class="w-9 h-9 rounded-full border">
                <button onclick="logout()" class="text-xs font-bold text-red-500">LOGOUT</button>
            </div>
        </header>

        <main class="p-4 max-w-4xl mx-auto space-y-6">
            
            <section id="tab-dashboard" class="space-y-6">
                <div class="grid grid-cols-2 gap-4 text-white">
                    <div class="bg-slate-900 p-5 rounded-[2rem] card-shadow">
                        <p class="text-[10px] opacity-60 font-bold uppercase">Total Revenue</p>
                        <h2 id="stat-revenue" class="text-xl font-black">0 Ks</h2>
                    </div>
                    <div class="bg-orange-500 p-5 rounded-[2rem] card-shadow">
                        <p class="text-[10px] opacity-80 font-bold uppercase">Orders</p>
                        <h2 id="stat-orders" class="text-xl font-black">0</h2>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[2rem] border border-slate-100 card-shadow">
                    <h3 class="text-sm font-black mb-4 uppercase">Revenue Analysis</h3>
                    <canvas id="revenueChart" height="200"></canvas>
                </div>

                <div class="space-y-3">
                    <h3 class="text-sm font-black flex items-center gap-2">NEW ORDERS <span id="order-bell">ðŸ””</span></h3>
                    <div id="dashboard-new-orders" class="space-y-3"></div>
                </div>
            </section>

            <section id="tab-orders" class="hidden space-y-4">
                <div class="flex bg-slate-100 p-1 rounded-2xl gap-1">
                    <button onclick="changeFilter('not_confirm')" id="btn-not_confirm" class="status-tab active flex-1 py-3 text-[10px] font-black rounded-xl bg-white shadow">NEW</button>
                    <button onclick="changeFilter('pending')" id="btn-pending" class="status-tab flex-1 py-3 text-[10px] font-black rounded-xl">PENDING</button>
                    <button onclick="changeFilter('ready')" id="btn-ready" class="status-tab flex-1 py-3 text-[10px] font-black rounded-xl">READY</button>
                </div>
                <div id="order-list" class="space-y-4"></div>
            </section>

            <section id="tab-menu" class="hidden space-y-4">
                <button onclick="openMenuModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black">+ ADD NEW MENU</button>
                <div id="admin-menu-list" class="space-y-2"></div>
            </section>

        </main>
    </div>

    <div id="menu-modal" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-4">
            <h3 class="text-lg font-black">Item Configuration</h3>
            <div class="flex flex-col items-center gap-2">
                <img id="m-preview" src="https://placehold.co/100" class="w-20 h-20 rounded-2xl object-cover border-2 border-dashed">
                <input type="file" onchange="uploadToImgBB(this)" class="hidden" id="m-file">
                <button onclick="document.getElementById('m-file').click()" class="text-[10px] font-black text-orange-500 uppercase">Upload Photo</button>
                <input type="hidden" id="m-image-url">
                <div id="upload-status" class="hidden text-[9px] font-bold">Uploading...</div>
            </div>
            <input type="text" id="m-name" placeholder="Item Name" class="w-full p-4 rounded-xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold">
            <select id="m-category" class="w-full p-4 rounded-xl bg-slate-50 border-none ring-1 ring-slate-100 font-bold">
                <option value="á€¡á€žá€¬á€¸á€€á€„á€º">á€¡á€žá€¬á€¸á€€á€„á€º</option>
                <option value="á€¡á€¡á€±á€¸">á€¡á€¡á€±á€¸</option>
                <option value="á€Ÿá€„á€ºá€¸á€•á€½á€²">á€Ÿá€„á€ºá€¸á€•á€½á€²</option>
            </select>
            <div class="grid grid-cols-2 gap-2">
                <input type="number" id="m-price" placeholder="Price" class="p-4 rounded-xl bg-slate-50 ring-1 ring-slate-100 font-bold">
                <input type="number" id="m-stock" placeholder="Stock" class="p-4 rounded-xl bg-slate-50 ring-1 ring-slate-100 font-bold">
            </div>
            <div class="flex gap-2">
                <button onclick="closeMenuModal()" class="flex-1 py-4 font-black text-slate-400">Cancel</button>
                <button onclick="saveMenu()" id="save-btn" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-black">Save Now</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white border-t flex items-center justify-around px-2 z-[90]">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-text nav-active text-[10px] py-2 px-4 uppercase tracking-tighter">Dashboard</button>
        <button onclick="switchTab('orders')" id="nav-orders" class="nav-text text-[10px] py-2 px-4 uppercase tracking-tighter">Orders</button>
        <button onclick="switchTab('menu')" id="nav-menu" class="nav-text text-[10px] py-2 px-4 uppercase tracking-tighter">Menu</button>
    </nav>

    <audio id="notiSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCW_jACdwWmN2nwlEOxR6tdTBqLXHyvE0w",
            authDomain: "myin-thar-chicken-bbq.firebaseapp.com",
            databaseURL: "https://myin-thar-chicken-bbq-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myin-thar-chicken-bbq",
            storageBucket: "myin-thar-chicken-bbq.firebasestorage.app",
            messagingSenderId: "45639130854",
            appId: "1:45639130854:web:779ecef328580d10e9e527"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const IMGBB_KEY = "6e69492668a1c3a337306b5aa690d874";
        const ADMIN_EMAIL = "yewin5375@gmail.com";

        let orders = [], menus = [], currentFilter = 'not_confirm', chart = null;

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                document.getElementById('admin-profile').src = user.photoURL;
                if (!("Notification" in window)) alert("Browser doesn't support noti");
                else Notification.requestPermission();
                fetchData();
            } else {
                if (user) auth.signOut();
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { auth.signOut(); }

        // --- FETCH & REALTIME ---
        function fetchData() {
            db.ref('orders').on('value', s => {
                const prevCount = orders.length;
                const d = s.val();
                orders = d ? Object.keys(d).map(id => ({ id, ...d[id] })).reverse() : [];
                
                // New Order Notification Logic
                if (orders.length > prevCount && prevCount !== 0) {
                    const latest = orders[0];
                    if (latest.status === 'not_confirm') triggerAlert(latest);
                }
                
                updateUI();
                renderGraph();
            });
            db.ref('menus').on('value', s => {
                const d = s.val();
                menus = d ? Object.keys(d).map(id => ({ id, ...d[id] })) : [];
                renderMenus();
            });
        }

        function triggerAlert(order) {
            document.getElementById('notiSound').play();
            if (Notification.permission === "granted") {
                new Notification("Order á€¡á€žá€…á€ºá€á€€á€ºá€œá€¬á€•á€«á€•á€¼á€®!", {
                    body: `${order.customer_name} á€‘á€¶á€™á€¾ ${order.total_amount} Ks á€–á€­á€¯á€¸á€™á€¾á€¬á€šá€°á€‘á€¬á€¸á€•á€«á€žá€Šá€º`,
                    icon: "https://cdn-icons-png.flaticon.com/512/3502/3502601.png"
                });
            }
            Swal.fire({ title: 'New Order!', text: `${order.customer_name} just ordered.`, icon: 'info', toast: true, position: 'top-end', showConfirmButton: false, timer: 5000 });
        }

        function updateUI() {
            document.getElementById('stat-revenue').innerText = orders.reduce((s,o)=>s+o.total_amount,0).toLocaleString() + " Ks";
            document.getElementById('stat-orders').innerText = orders.length;
            
            // Dashboard New Orders
            const news = orders.filter(o => o.status === 'not_confirm').slice(0, 3);
            document.getElementById('dashboard-new-orders').innerHTML = news.map(o => `
                <div class="bg-white p-4 rounded-2xl border-l-4 border-orange-500 shadow-sm flex justify-between items-center">
                    <div><p class="font-black text-sm">${o.customer_name}</p><p class="text-xs font-bold text-slate-400">${o.total_amount} Ks</p></div>
                    <button onclick="switchTab('orders')" class="text-[10px] font-black text-orange-500 uppercase">View</button>
                </div>
            `).join('');

            renderOrders();
        }

        // --- GRAPH ---
        function renderGraph() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const dailyData = {};
            orders.slice(0, 7).forEach(o => {
                const date = new Date(o.created_at).toLocaleDateString();
                dailyData[date] = (dailyData[date] || 0) + o.total_amount;
            });

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dailyData),
                    datasets: [{ label: 'Revenue', data: Object.values(dailyData), borderColor: '#f97316', tension: 0.4, fill: true, backgroundColor: 'rgba(249, 115, 22, 0.1)' }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        // --- ORDER TAB RENDER ---
        function renderOrders() {
            const filtered = orders.filter(o => o.status === currentFilter);
            document.getElementById('order-list').innerHTML = filtered.map(o => `
                <div class="bg-white p-5 rounded-[2rem] border border-slate-100 card-shadow">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-orange-500">#${o.id.slice(-6)}</span>
                        <span class="text-[9px] font-bold text-slate-400">${new Date(o.created_at).toLocaleTimeString()}</span>
                    </div>
                    <h4 class="font-black text-base mb-2">${o.customer_name}</h4>
                    <div class="space-y-1 mb-4">
                        ${o.items.map(i => `<div class="flex justify-between text-xs font-bold text-slate-500"><span>${i.name} x${i.qty}</span><span>${i.price*i.qty}</span></div>`).join('')}
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-lg font-black">${o.total_amount.toLocaleString()} Ks</p>
                        ${o.status==='not_confirm'? `<button onclick="updateStatus('${o.id}','pending')" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-black">Accept</button>`:''}
                        ${o.status==='pending'? `<button onclick="updateStatus('${o.id}','ready')" class="bg-orange-500 text-white px-5 py-2 rounded-xl text-xs font-black">Ready</button>`:''}
                    </div>
                </div>
            `).join('');
        }

        // --- MENU LOGIC ---
        function renderMenus() {
            document.getElementById('admin-menu-list').innerHTML = menus.map(m => `
                <div class="bg-white p-4 rounded-2xl flex items-center justify-between border border-slate-50 shadow-sm">
                    <div class="flex items-center gap-3">
                        <img src="${m.image_url}" class="w-12 h-12 rounded-xl object-cover">
                        <div>
                            <p class="font-black text-sm">${m.name}</p>
                            <p class="text-[9px] font-bold text-orange-500 uppercase">${m.category} | ${m.price} Ks</p>
                        </div>
                    </div>
                    <button onclick="deleteMenu('${m.id}')" class="text-red-400 p-2">ðŸ—‘</button>
                </div>
            `).join('');
        }

        async function uploadToImgBB(input) {
            if (!input.files[0]) return;
            document.getElementById('upload-status').classList.remove('hidden');
            const fd = new FormData(); fd.append("image", input.files[0]);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const data = await res.json();
            document.getElementById('m-image-url').value = data.data.url;
            document.getElementById('m-preview').src = data.data.url;
            document.getElementById('upload-status').classList.add('hidden');
        }

        async function saveMenu() {
            const name = document.getElementById('m-name').value;
            const price = parseInt(document.getElementById('m-price').value);
            const cat = document.getElementById('m-category').value;
            const img = document.getElementById('m-image-url').value;
            if(!name || !price || !img) return Swal.fire('Error','Complete all fields','warning');
            
            await db.ref('menus').push({ name, price, category: cat, image_url: img, stock: parseInt(document.getElementById('m-stock').value || 0) });
            closeMenuModal();
        }

        // --- GENERAL HELPERS ---
        function switchTab(t) {
            ['dashboard', 'orders', 'menu'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.nav-text').forEach(n => n.classList.remove('nav-active'));
            document.getElementById('nav-'+t).classList.add('nav-active');
        }
        function changeFilter(s) {
            currentFilter = s;
            document.querySelectorAll('.status-tab').forEach(b => { b.classList.remove('active','bg-white','shadow'); b.classList.add('text-slate-400'); });
            const btn = document.getElementById('btn-'+s);
            btn.classList.add('active','bg-white','shadow'); btn.classList.remove('text-slate-400');
            renderOrders();
        }
        function openMenuModal() { document.getElementById('menu-modal').classList.remove('hidden'); }
        function closeMenuModal() { document.getElementById('menu-modal').classList.add('hidden'); }
        async function updateStatus(id, s) { await db.ref('orders/'+id).update({status: s}); }
        async function deleteMenu(id) { if(confirm('Delete this item?')) await db.ref('menus/'+id).remove(); }
    </script>
</body>
</html>
