<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Food Order System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* Tailwind á€¡á€•á€¼á€„á€º á€‘á€•á€ºá€–á€¼á€Šá€·á€ºá€á€»á€„á€ºá€á€²á€· Custom CSS */
        body { font-family: 'Pyidaungsu', sans-serif, system-ui; }
        .menu-card { transition: transform 0.2s; }
        .menu-card:hover { transform: translateY(-5px); }
        #cart-modal { backdrop-filter: blur(4px); }
        /* á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€¡á€€á€½á€€á€ºá€¡á€á€½á€€á€º Dynamic Height */
#cart-items {
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 160px; /* á€™á€°á€œá€¡á€™á€¼á€„á€·á€º (á€á€±á€¸á€á€±á€¸á€œá€±á€¸) */
}

/* á€€á€¼á€®á€¸á€œá€¬á€á€²á€·á€¡á€á€»á€­á€”á€ºá€™á€¾á€¬ á€á€¯á€¶á€¸á€™á€šá€·á€º Class */
#cart-items.expanded {
    max-height: 65vh; /* Screen á€›á€²á€· 65% á€¡á€‘á€­ á€€á€¼á€®á€¸á€œá€¬á€™á€šá€º */
}

/* á€¡á€•á€¼á€„á€ºá€€á€”á€±á€›á€¬á€œá€½á€á€ºá€€á€­á€¯ á€”á€¾á€­á€•á€ºá€›á€„á€º á€•á€­á€á€ºá€–á€­á€¯á€· Overlay */
#cart-height-overlay {
    display: none;
}
#cart-height-overlay.show {
    display: block;
}
        
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-orange-500 p-4 text-white shadow-md sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tight italic">FOODIE</h1>
            <button onclick="toggleCart()" class="relative bg-white text-orange-600 px-5 py-2 rounded-full font-bold shadow-sm hover:bg-orange-50 transition flex items-center gap-2">
                <span>ğŸ›’ Cart</span>
                <span id="cart-count" class="bg-orange-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </nav>
     <div id="status-container" class="max-w-4xl mx-auto p-4 hidden">
    <div class="bg-orange-100 border-2 border-orange-500 p-6 rounded-[2rem] text-center shadow-lg shadow-orange-100">
        <p class="text-orange-800 font-bold mb-1">á€á€„á€·á€ºá€¡á€±á€¬á€ºá€’á€« á€¡á€á€¼á€±á€¡á€”á€±</p>
        <h3 id="current-status-text" class="text-3xl font-black text-orange-600 italic">NEW</h3>
        <p class="text-[10px] text-orange-400 mt-2 italic">* Admin á€˜á€€á€ºá€€ á€¡á€•á€¼á€±á€¬á€„á€ºá€¸á€¡á€œá€²á€œá€¯á€•á€ºá€›á€„á€º á€’á€®á€™á€¾á€¬ Real-time á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€«á€œá€­á€™á€·á€ºá€™á€šá€º</p>
    </div>
     </div>
    
    <header class="max-w-4xl mx-auto p-6 text-center">
        <h2 class="text-3xl font-bold text-slate-900">á€…á€¬á€¸á€á€±á€¬á€€á€ºá€–á€½á€šá€ºá€›á€¬á€™á€»á€¬á€¸</h2>
        <p class="text-slate-500">á€”á€¾á€…á€ºá€á€€á€ºá€›á€¬á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€¼á€®á€¸ Order á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€•á€¼á€®á‹</p>
    </header>

    <main class="max-w-4xl mx-auto p-4 mb-10">
        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="animate-pulse bg-white p-6 rounded-2xl h-32 shadow-sm"></div>
            <div class="animate-pulse bg-white p-6 rounded-2xl h-32 shadow-sm"></div>
        </div>
    </main>

<div id="cart-modal" class="fixed inset-0 bg-slate-900/60 hidden z-[100] transition-opacity">
    <div id="cart-height-overlay" class="absolute inset-0 z-0" onclick="toggleCartHeight(false)"></div>

    <div class="relative bg-white w-full max-w-md ml-auto h-full p-6 shadow-2xl flex flex-col z-10">
        <div class="flex justify-between items-center mb-4 border-b pb-4">
            <h2 class="text-2xl font-bold italic text-slate-800">ğŸ›’ MY CART</h2>
            <button onclick="toggleCart()" class="text-slate-400 hover:text-orange-500 text-3xl font-light leading-none">&times;</button>
        </div>
        
        <div id="cart-items" onclick="toggleCartHeight(true)" class="overflow-y-auto space-y-4 pr-2 bg-slate-50 p-3 rounded-2xl border-2 border-transparent hover:border-orange-100 transition-all cursor-pointer relative min-h-[100px]">
            <div id="expand-hint" class="absolute bottom-1 right-3 text-[9px] font-bold text-orange-400 animate-pulse">á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ á€•á€¼á€„á€ºá€†á€„á€ºá€›á€”á€º â†—</div>
        </div>

        <div class="border-t pt-4 mt-4 flex-1 flex flex-col overflow-hidden">
            <div class="flex justify-between text-xl font-black mb-4 px-2">
                <span>Total:</span>
                <span class="text-orange-600 font-black"><span id="cart-total">0</span> MMK</span>
            </div>

            <form id="order-form" class="space-y-3 bg-slate-50 p-4 rounded-3xl overflow-y-auto flex-1">
                <input type="text" id="cust-name" placeholder="á€á€„á€·á€ºá€”á€¬á€™á€Šá€º" required class="w-full border-none ring-1 ring-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition text-sm">
                <input type="tel" id="cust-phone" placeholder="á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º" required class="w-full border-none ring-1 ring-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition text-sm">
                
                <div class="flex gap-2">
                    <div class="w-1/2">
                        <label class="text-[10px] font-bold text-slate-400 ml-1">Date</label>
                        <input type="date" id="pickup-date" required class="w-full border-none ring-1 ring-slate-200 p-2 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition text-sm">
                    </div>
                    <div class="w-1/2">
                        <label class="text-[10px] font-bold text-slate-400 ml-1">Time</label>
                        <input type="time" id="pickup-time" required class="w-full border-none ring-1 ring-slate-200 p-2 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition text-sm">
                    </div>
                </div>
                
                <textarea id="note" rows="2" placeholder="á€™á€¾á€á€ºá€á€»á€€á€º" class="w-full border-none ring-1 ring-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition text-sm"></textarea>
                
                <button type="submit" id="submit-btn" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black text-lg hover:bg-orange-600 active:scale-95 transition-all shadow-lg shadow-orange-100 mt-2">
                    CONFIRM ORDER
                </button>
            </form>
        </div>
    </div>
</div>
    <div id="orders-overlay" class="fixed inset-0 bg-slate-50 z-[200] hidden overflow-y-auto">
    <nav class="bg-white p-4 shadow-sm sticky top-0 flex justify-between items-center px-6">
        <h2 class="text-xl font-bold italic text-orange-600">MY ORDERS</h2>
        <button onclick="closeOrders()" class="text-3xl text-slate-400 leading-none">&times;</button>
    </nav>
    <div class="max-w-md mx-auto p-4">
        <div class="bg-white p-5 rounded-3xl shadow-sm mb-6 border border-slate-100">
            <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€ºá€–á€¼á€„á€·á€º á€¡á€±á€¬á€ºá€’á€«á€•á€¼á€”á€ºá€›á€¾á€¬á€›á€”á€º</p>
            <div class="flex gap-2">
                <input type="tel" id="order-search-phone" placeholder="09..." class="flex-1 bg-slate-50 p-3 rounded-xl outline-none ring-1 ring-slate-200 focus:ring-2 focus:ring-orange-500">
                <button onclick="loadMyOrders()" class="bg-orange-500 text-white px-5 rounded-xl font-bold text-sm active:scale-95 transition-all">á€›á€¾á€¬á€™á€Šá€º</button>
            </div>
        </div>

        <div class="flex border-b mb-6 bg-white rounded-t-3xl overflow-hidden">
            <button id="tab-active" onclick="switchTab('active')" class="flex-1 py-4 font-bold border-b-2 border-orange-500 text-orange-600 transition-all">Active Orders</button>
            <button id="tab-past" onclick="switchTab('past')" class="flex-1 py-4 font-bold text-slate-400 border-b-2 border-transparent transition-all">Past Orders</button>
        </div>

        <div id="orders-list" class="space-y-4 pb-24">
            <p class="text-center text-slate-400 py-10 italic">á€¡á€±á€¬á€ºá€’á€«á€™á€¾á€á€ºá€á€™á€ºá€¸á€€á€­á€¯ á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€ºá€–á€¼á€„á€·á€º á€›á€¾á€¬á€–á€½á€±á€•á€«á‹</p>
        </div>
    </div>
</div>

<button onclick="openOrders()" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-full shadow-2xl z-50 flex items-center gap-3 active:scale-90 transition-all">
    <span class="text-xl">ğŸ“‹</span>
    <span class="font-bold text-sm tracking-tight">My Orders</span>
</button>

    
    <script>
        // --- Configuration ---
        const SUPABASE_URL = 'https://rvqkolgbykgsqjupmedf.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2cWtvbGdieWtnc3FqdXBtZWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MDcyNTAsImV4cCI6MjA4MzI4MzI1MH0.fqxJ9aHAHmySpmTaJ-tpfeEsE7IFBr-JkYIdAQCLjQs'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let menuData = [];
        let cart = [];

        // --- Fetch Menu ---
        async function fetchMenu() {
    console.log("Fetching menu...");
    // Filter á€€á€­á€¯ á€á€±á€á€¹á€á€–á€¼á€¯á€á€ºá€•á€¼á€®á€¸ á€…á€™á€ºá€¸á€á€•á€ºá€€á€¼á€Šá€·á€ºá€•á€« (Data á€á€€á€ºá€™á€á€€á€º á€á€­á€›á€¡á€±á€¬á€„á€º)
    const { data, error } = await _supabase
        .from('menus')
        .select('*')
        .order('name'); 
    
    if (error) {
        console.error("Supabase Error:", error);
        document.getElementById('menu-container').innerHTML = `<p class="text-red-500 text-center">Error: ${error.message}</p>`;
        return;
    }
    
    if (data.length === 0) {
        document.getElementById('menu-container').innerHTML = `<p class="text-slate-400 text-center py-10">á€Ÿá€„á€ºá€¸á€•á€½á€²á€™á€»á€¬á€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹ Admin Panel á€á€½á€„á€º á€¡á€›á€„á€ºá€‘á€Šá€·á€ºá€•á€«á‹</p>`;
        return;
    }

    menuData = data;
    renderMenu();
        }
        


        function renderMenu() {
    const container = document.getElementById('menu-container');
    container.innerHTML = menuData.map(item => `
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden flex flex-col">
            <img src="${item.image_url}" alt="${item.name}" class="w-full h-48 object-cover">
            <div class="p-4 flex justify-between items-center">
                <div class="flex-1">
                    <h3 class="font-extrabold text-lg text-slate-800">${item.name}</h3>
                    <p class="text-orange-500 font-bold text-md">${item.price.toLocaleString()} MMK</p>
                </div>
                <button onclick="addToCart('${item.id}')" class="bg-orange-50 text-orange-600 px-4 py-2 rounded-2xl font-bold hover:bg-orange-500 hover:text-white transition-all active:scale-90">
                    + Add
                </button>
            </div>
        </div>
    `).join('');
}


        // --- Cart Functions ---
        window.addToCart = (id) => {
            const item = menuData.find(m => m.id === id);
            const inCart = cart.find(c => c.id === id);
            if (inCart) { inCart.qty += 1; } 
            else { cart.push({ ...item, qty: 1 }); }
            updateCartUI();
        };

        function updateCartUI() {
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');

            cartCount.innerText = cart.reduce((sum, item) => sum + item.qty, 0);
            
            if (cart.length === 0) {
                cartItems.innerHTML = `<p class="text-center text-slate-400 py-10 italic">á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€‘á€²á€™á€¾á€¬ á€˜á€¬á€™á€¾á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>`;
                cartTotal.innerText = "0";
                return;
            }

            let total = 0;
            cartItems.innerHTML = cart.map((item, index) => {
                total += item.price * item.qty;
                return `
                    <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <div>
                            <p class="font-bold text-slate-800">${item.name}</p>
                            <p class="text-xs text-slate-500 mt-1">
                                <button onclick="changeQty(${index}, -1)" class="px-2 bg-white rounded border">-</button>
                                <span class="mx-2 font-bold">${item.qty}</span>
                                <button onclick="changeQty(${index}, 1)" class="px-2 bg-white rounded border">+</button>
                                <span class="ml-4 font-semibold text-orange-600">${(item.price * item.qty).toLocaleString()} MMK</span>
                            </p>
                        </div>
                        <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 p-2">&times;</button>
                    </div>
                `;
            }).join('');
            cartTotal.innerText = total.toLocaleString();
        }

        window.changeQty = (index, amount) => {
            cart[index].qty += amount;
            if (cart[index].qty <= 0) cart.splice(index, 1);
            updateCartUI();
        }

        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            updateCartUI();
        }

        window.toggleCart = () => {
            const modal = document.getElementById('cart-modal');
            modal.classList.toggle('hidden');
        };
         function toggleCartHeight(expand) {
    const cartBox = document.getElementById('cart-items');
    const overlay = document.getElementById('cart-height-overlay');
    const hint = document.getElementById('expand-hint');

    if (expand) {
        cartBox.classList.add('expanded');
        overlay.classList.add('show');
        if(hint) hint.style.display = 'none'; // á€€á€¼á€®á€¸á€á€½á€¬á€¸á€›á€„á€º hint á€–á€»á€±á€¬á€€á€ºá€™á€šá€º
    } else {
        cartBox.classList.remove('expanded');
        overlay.classList.remove('show');
        if(hint) hint.style.display = 'block'; // á€á€±á€¸á€á€½á€¬á€¸á€›á€„á€º hint á€•á€¼á€”á€ºá€•á€¼á€™á€šá€º
    }
         }
        
        // --- Submit Order ---
                // --- Submit Order (Updated for New SQL) ---
        document.getElementById('order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (cart.length === 0) return alert("á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€‘á€²á€™á€¾á€¬ á€•á€…á€¹á€…á€Šá€ºá€¸á€¡á€›á€„á€ºá€‘á€Šá€·á€ºá€•á€«!");

            const btn = document.getElementById('submit-btn');
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;

            btn.innerText = "Sending...";
            btn.disabled = true;

            // áá‹ Customer Table á€™á€¾á€¬ á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€ºá€›á€¾á€­á€™á€›á€¾á€­ á€¡á€›á€„á€ºá€…á€…á€ºá€™á€šá€º (á€™á€›á€¾á€­á€›á€„á€º á€¡á€á€…á€ºá€á€½á€„á€ºá€¸á€™á€šá€º)
            const { data: customer, error: custErr } = await _supabase
                .from('customer_users')
                .upsert({ 
                    phone: phone, 
                    full_name: name 
                }, { onConflict: 'phone' })
                .select()
                .single();

            if (custErr) {
                alert("Customer Error: " + custErr.message);
                btn.innerText = "Confirm Order";
                btn.disabled = false;
                return;
            }

            // á‚á‹ Orders Table á€‘á€² á€‘á€Šá€·á€ºá€™á€šá€º
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const { data: order, error: orderErr } = await _supabase
                .from('orders')
                .insert([{
                    customer_phone: phone, // customer_phone á€œá€­á€¯á€· á€•á€¼á€±á€¬á€„á€ºá€¸á€‘á€¬á€¸á€á€Šá€º
                    customer_name: name,
                    pickup_date: document.getElementById('pickup-date').value,
                    pickup_time: document.getElementById('pickup-time').value,
                    note: document.getElementById('note').value,
                    total_amount: total,
                    status: 'new'
                }])
                .select().single();

            if (orderErr) {
                alert("Order error: " + orderErr.message);
                btn.innerText = "Confirm Order";
                btn.disabled = false;
                return;
            }

            // áƒá‹ Order Items á€‘á€² á€‘á€Šá€·á€ºá€™á€šá€º (á€’á€®á€™á€¾á€¬ Stock á€€ á€¡á€œá€­á€¯á€œá€­á€¯ á€œá€»á€±á€¬á€·á€á€½á€¬á€¸á€•á€«á€œá€­á€™á€·á€ºá€™á€šá€º)
            const itemsToInsert = cart.map(item => ({
                order_id: order.id,
                menu_id: item.id,
                quantity: item.qty,
                price_at_time: item.price
            }));

            const { error: itemsErr } = await _supabase.from('order_items').insert(itemsToInsert);

            if (itemsErr) {
                console.error("Items Insert Error:", itemsErr);
            }
             // --- Telegram á€•á€­á€¯á€·á€›á€”á€º á€’á€®á€”á€±á€›á€¬á€™á€¾á€¬ á€‘á€Šá€·á€ºá€•á€« ---
const token = "8215695761:AAF1qDjAJn7gjiHyzf8t7W6c8e51cim98sU";
const chatId = "8116152317";

// á€•á€…á€¹á€…á€Šá€ºá€¸á€…á€¬á€›á€„á€ºá€¸á€€á€­á€¯ á€á€…á€ºá€€á€¼á€±á€¬á€„á€ºá€¸á€á€»á€„á€ºá€¸á€…á€® á€…á€®á€™á€Šá€·á€ºá€¡á€•á€­á€¯á€„á€ºá€¸
let itemDetails = "";
cart.forEach((item) => {
    itemDetails += `${item.name} - ${item.price}ks x ${item.qty} = ${item.price * item.qty}ks\n`;
});

// á€™á€„á€ºá€¸á€œá€­á€¯á€á€»á€„á€ºá€á€²á€· Format á€¡á€á€­á€¯á€„á€ºá€¸ á€…á€¬á€á€¬á€¸á€á€Šá€ºá€†á€±á€¬á€€á€ºá€á€¼á€„á€ºá€¸
const telegramText = `ğŸ”” <b>á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º á€›á€±á€¬á€€á€ºá€›á€¾á€­á€œá€¬á€•á€«á€•á€¼á€®!</b>\n\n` +
             `ğŸ‘¤ <b>á€¡á€™á€Šá€º:</b> ${name}\n\n` +
             `ğŸ“ <b>á€–á€¯á€”á€ºá€¸:</b> ${phone}\n\n` +
             `ğŸ“… <b>Date:</b> ${document.getElementById('pickup-date').value}    ğŸ•’ <b>Time:</b> ${document.getElementById('pickup-time').value}\n\n` +
             `ğŸ›’ <b>á€™á€¾á€¬á€šá€°á€‘á€¬á€¸á€á€Šá€ºá€™á€»á€¬á€¸:</b>\n\n` +
             `<b>Name               price         quantity      total</b>\n` +
             `--------------------------------------------------\n` +
             `${itemDetails}\n` +
             `ğŸ’° <b>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€€á€»á€á€„á€·á€ºá€„á€½á€±: ${total.toLocaleString()} ks</b>\n\n` +
             `âœ… <a href="https://yewin5375.github.io/YeNaingSoe-/admin.html">Admin Dashboard</a>`;

// Telegram API á€á€­á€¯á€· á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: chatId, parse_mode: 'HTML', text: telegramText })
});
// ---------------------------------------
            
            alert("Order á€á€„á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€ºá‹ á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€ºá‹");
            // á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€•á€¼á€®á€¸á€á€¬á€”á€²á€· á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€ºá€€á€­á€¯ search box á€™á€¾á€¬ á€‘á€Šá€·á€ºá€•á€¼á€®á€¸ tracking window á€–á€½á€„á€·á€ºá€•á€±á€¸á€™á€šá€º
document.getElementById('order-search-phone').value = phone;
openOrders();
            
            // alert á€…á€¬á€á€¬á€¸á€›á€²á€· á€¡á€±á€¬á€€á€ºá€™á€¾á€¬ á€’á€«á€œá€±á€¸ á€‘á€Šá€·á€ºá€•á€«
startRealtimeWatch(order.id);
            
            // UI Reset
            cart = [];
            updateCartUI();
            toggleCart();
            document.getElementById('order-form').reset();
            btn.innerText = "Confirm Order";
            btn.disabled = false;
        });
        
    // á€¡á€±á€¬á€ºá€’á€« Status á€€á€­á€¯ Real-time á€…á€±á€¬á€„á€·á€ºá€€á€¼á€Šá€·á€ºá€™á€šá€·á€º Function
function startRealtimeWatch(orderId) {
    document.getElementById('status-container').classList.remove('hidden');
    
    _supabase
        .channel('order-status')
        .on('postgres_changes', { 
            event: 'UPDATE', 
            schema: 'public', 
            table: 'orders', 
            filter: `id=eq.${orderId}` 
        }, payload => {
            const status = payload.new.status.toUpperCase();
            document.getElementById('current-status-text').innerText = status;
            
            // Notification á€•á€±á€¸á€™á€šá€º
            if(status === 'PENDING') alert("ğŸ³ á€†á€­á€¯á€„á€ºá€€ á€á€„á€·á€ºá€¡á€±á€¬á€ºá€’á€«á€€á€­á€¯ á€…á€á€„á€ºá€á€»á€€á€ºá€•á€¼á€¯á€á€ºá€”á€±á€•á€«á€•á€¼á€®á‹");
            if(status === 'FINISHED') alert("âœ… á€¡á€±á€¬á€ºá€’á€«á€¡á€†á€„á€ºá€á€„á€·á€ºá€–á€¼á€…á€ºá€•á€«á€•á€¼á€®á‹ á€œá€¬á€šá€°á€”á€­á€¯á€„á€ºá€•á€«á€•á€¼á€®á‹");
        })
        .subscribe();
}
       
async function checkHistory() {
    const phone = document.getElementById('cust-phone').value;
    if(!phone) return alert("á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º á€¡á€›á€„á€ºá€›á€­á€¯á€€á€ºá€•á€«");
    
    const { data } = await _supabase.from('orders').select('*').eq('customer_phone', phone).order('created_at', {ascending: false});
    if(data.length > 0) {
        alert(`á€™á€„á€ºá€¸á€™á€¾á€¬ á€¡á€±á€¬á€ºá€’á€«á€Ÿá€±á€¬á€„á€ºá€¸ ${data.length} á€á€¯ á€›á€¾á€­á€•á€«á€á€šá€ºá‹ á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€¡á€±á€¬á€ºá€’á€« Status á€€ ${data[0].status} á€•á€«á‹`);
    } else {
        alert("á€™á€¾á€¬á€šá€°á€–á€°á€¸á€á€¼á€„á€ºá€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹");
    }
       }

        let currentOrderTab = 'active';

// Window á€–á€½á€„á€·á€ºá€á€¼á€„á€ºá€¸/á€•á€­á€á€ºá€á€¼á€„á€ºá€¸
function openOrders() {
    document.getElementById('orders-overlay').classList.remove('hidden');
    const savedPhone = localStorage.getItem('last_customer_phone');
    if(savedPhone) {
        document.getElementById('order-search-phone').value = savedPhone;
        loadMyOrders();
    }
}

function closeOrders() {
    document.getElementById('orders-overlay').classList.add('hidden');
}

// Tab á€•á€¼á€±á€¬á€„á€ºá€¸á€á€¼á€„á€ºá€¸
function switchTab(tab) {
    currentOrderTab = tab;
    document.getElementById('tab-active').className = tab === 'active' ? "flex-1 py-4 font-bold border-b-2 border-orange-500 text-orange-600" : "flex-1 py-4 font-bold text-slate-400 border-b-2 border-transparent";
    document.getElementById('tab-past').className = tab === 'past' ? "flex-1 py-4 font-bold border-b-2 border-orange-500 text-orange-600" : "flex-1 py-4 font-bold text-slate-400 border-b-2 border-transparent";
    loadMyOrders();
}

// Database á€™á€¾ á€¡á€±á€¬á€ºá€’á€«á€™á€»á€¬á€¸ á€†á€½á€²á€‘á€¯á€á€ºá€á€¼á€„á€ºá€¸
async function loadMyOrders() {
    const phone = document.getElementById('order-search-phone').value;
    if(!phone) return alert("á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º á€¡á€›á€„á€ºá€›á€­á€¯á€€á€ºá€•á€«");
    
    localStorage.setItem('last_customer_phone', phone);
    const container = document.getElementById('orders-list');
    container.innerHTML = `<div class="text-center py-10"><div class="animate-spin inline-block w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full"></div></div>`;

    const { data, error } = await _supabase
        .from('orders')
        .select('*, order_items(*, menus(name))')
        .eq('customer_phone', phone)
        .order('created_at', { ascending: false });

    if(error || !data.length) {
        container.innerHTML = `<p class="text-center py-10 text-slate-400 italic">á€¡á€±á€¬á€ºá€’á€«á€™á€¾á€á€ºá€á€™á€ºá€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>`;
        return;
    }

    // Tab á€¡á€œá€­á€¯á€€á€º Filter á€…á€…á€ºá€á€¼á€„á€ºá€¸
    const filtered = data.filter(o => 
        currentOrderTab === 'active' ? (o.status !== 'finished' && o.status !== 'rejected') : (o.status === 'finished' || o.status === 'rejected')
    );

    if(filtered.length === 0) {
        container.innerHTML = `<p class="text-center py-10 text-slate-400 italic">á€™á€¾á€á€ºá€á€™á€ºá€¸ á€™á€›á€¾á€­á€á€±á€¸á€•á€«á‹</p>`;
        return;
    }

    container.innerHTML = filtered.map(order => `
        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 transition-all hover:shadow-md">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span class="text-[10px] font-black text-orange-600 uppercase bg-orange-50 px-3 py-1 rounded-full ring-1 ring-orange-200">${order.status}</span>
                    <h3 class="font-bold text-slate-800 mt-4">${new Date(order.created_at).toLocaleDateString()}</h3>
                </div>
                <p class="font-black text-lg text-slate-800">${order.total_amount.toLocaleString()} <span class="text-[10px] text-slate-400 ml-1">MMK</span></p>
            </div>
            <div class="space-y-2 mb-2 border-t border-dashed pt-4">
                ${order.order_items.map(item => `
                    <p class="text-xs text-slate-500 flex justify-between font-medium">
                        <span>${item.menus?.name || 'á€Ÿá€„á€ºá€¸á€•á€½á€²'} x ${item.quantity}</span> 
                        <span>${(item.price_at_time * item.quantity).toLocaleString()} Ks</span>
                    </p>
                `).join('')}
            </div>
        </div>
    `).join('');
}

// Real-time Update (Admin á€€ status á€•á€¼á€±á€¬á€„á€ºá€¸á€›á€„á€º á€¡á€œá€­á€¯á€œá€­á€¯ update á€–á€¼á€…á€ºá€¡á€±á€¬á€„á€º)
_supabase.channel('orders-realtime').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders' }, () => {
    if(!document.getElementById('orders-overlay').classList.contains('hidden')) loadMyOrders();
}).subscribe();

        fetchMenu();
    </script>
</body>
</html>
 
